services:
  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=alloy
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - alloy-postgres:/var/lib/postgresql/data

  alloy-agent:
    build:
      context: ..
      dockerfile: deploy/agent.Dockerfile
    expose:
      - "50051"
    ports:
      - "25565:25565"
    environment:
      - RUST_LOG=info
      - ALLOY_DATA_ROOT=/data
    volumes:
      - alloy-agent-data:/data

  alloy-agent-2:
    build:
      context: ..
      dockerfile: deploy/agent.Dockerfile
    expose:
      - "50051"
    environment:
      - RUST_LOG=info
      - ALLOY_DATA_ROOT=/data
    volumes:
      - alloy-agent-2-data:/data

  alloy-control:
    build:
      context: ..
      dockerfile: deploy/control.Dockerfile
    ports:
      - "8080:8080"
    environment:
      - RUST_LOG=info
      - ALLOY_AGENT_ENDPOINT=http://alloy-agent:50051
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/alloy
    depends_on:
      - postgres
      - alloy-agent

  web:
    build:
      context: ..
      dockerfile: deploy/web.Dockerfile
    ports:
      - "3000:80"
    depends_on:
      - alloy-control

volumes:
  alloy-agent-data:
  alloy-agent-2-data:
  alloy-postgres:
