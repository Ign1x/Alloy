# Alloy 更新思路清单（200条）

> 说明：按推荐程度从高到低排序。你可以直接在编辑器里勾选每条前面的 `[ ]`，后续也方便拆分成里程碑/Issue。

## P0（强烈推荐 / 近期做）
- [x] 001 [P0] 为每个实例把 stdout/stderr 持久化到磁盘（如 `instances/<id>/logs/`），不只保留内存 ring buffer
- [x] 002 [P0] UI 显示“启动失败原因”：exit code + 最后 N 行日志 + 可复制的错误详情
- [x] 003 [P0] 启动时把 `exec/cwd/args/env(关键字段)` 写入日志第一行，方便复现与排障（覆盖所有模板）
- [x] 004 [P0] 进程短命检测：启动后 <5s 退出则标记 `failed` 并保留原因/日志快照
- [x] 005 [P0] 增加 `RESTART` 按钮（stop+start），失败后可一键重试
- [x] 006 [P0] 支持“自动重启”策略（off/always/on-failure）并带指数退避与最大重试次数
- [x] 007 [P0] stop 流程增强：graceful stdin -> SIGTERM -> SIGKILL，每阶段都写入日志并可配置超时
- [x] 008 [P0] agent 退出/崩溃时清理子进程树（避免孤儿进程占端口/写盘）
- [x] 009 [P0] 端口分配持久化与冲突检测：启动前检查端口占用并给出明确提示
- [x] 010 [P0] UI 直接展示并复制连接信息（`host:port`）以及默认端口/公网映射提示
- [x] 011 [P0] 支持实例参数编辑（端口/内存/世界名等）+ 后端统一校验 + 变更风险提示
- [x] 012 [P0] Terraria 运行依赖自检（缺少动态库/权限时给出明确错误与建议）
- [x] 013 [P0] Docker runtime 镜像补齐 Terraria 运行依赖库并加一个最小 smoke check（启动后立刻退出也要有日志）
- [x] 014 [P0] 下载/解压/spawn 错误链路完整透出到 control/web（避免“无日志/没反应”）
- [x] 015 [P0] 下载缓存目录加锁（避免并发启动重复下载/写坏文件）
- [x] 016 [P0] Terraria zip 下载增加重试、超时与原子写入（可选断点续传）
- [x] 017 [P0] Terraria 解压后校验关键目录/文件（`Content/` `monoconfig/` `assemblies/` `TerrariaServer*`）
- [x] 018 [P0] 统一 `ALLOY_DATA_ROOT` 解析为绝对路径，避免 cwd 变化导致配置/世界路径错误
- [x] 019 [P0] FS API 加强 path traversal 防护（禁止 `..`、禁止访问 data root 外）
- [x] 020 [P0] FS API 权限分级（只读 vs 读写），默认只读并可在配置里显式开启写
- [x] 021 [P0] 在实例目录写入 `run.json`（模板、参数、启动时间、exec、cwd、版本等）便于诊断
- [x] 022 [P0] 实例增加可编辑的 `display_name`（UI 显示更友好，默认用 instance_id）
- [x] 023 [P0] UI 自动刷新做节流/退避（大量实例时避免高频轮询压垮 control/agent）
- [x] 024 [P0] 所有 RPC/HTTP 请求加 request-id，并贯穿 tracing 日志便于关联一次操作的全链路
- [x] 025 [P0] agent/tracing 日志写文件并支持一键下载“诊断包”（包含版本、配置、最近日志）
- [x] 026 [P0] Minecraft Java major 不匹配时，在 UI 给出“需要 Java X/当前 X”的可行动提示
- [x] 027 [P0] Minecraft jar 下载失败时显示来源 URL、期望 hash、实际 hash、缓存路径
- [x] 028 [P0] 实例删除二次确认：展示将删除的路径/估算大小，避免误删
- [x] 029 [P0] stop 后等待“世界保存完成”的 UX（基于日志关键字或等待窗口）并在超时后提示风险
- [x] 030 [P0] 进程资源使用采样（CPU/RSS/IO）写入 status，UI 展示基础指标
- [x] 031 [P0] start 后增加端口监听探测（TCP listen 成功才算 running，否则标记 failed）
- [x] 032 [P0] control `/healthz` 扩展：agent 连通性、磁盘空间、data root 权限、端口可用性
- [x] 033 [P0] 增加“只下载不启动”按钮（预热缓存，适合离线/快速启动）
- [x] 034 [P0] 版本选择防呆：默认只允许下拉；提供“高级模式”才允许手动输入版本
- [x] 035 [P0] Terraria `serverconfig.txt` 生成补全更多安全默认值（可选：motd、banlist、npcstream 等）
- [x] 036 [P0] UI 对 password/secret 字段默认隐藏（显示/复制按钮），避免肩窥与误分享截图
- [x] 037 [P0] 持久化审计日志（谁在什么时候 start/stop/delete/改参数），便于追溯
- [x] 038 [P0] 为模板引入参数 schema（类型/范围/默认值/secret 标记），后端输出机器可读错误
- [x] 039 [P0] Web 表单错误提示定位到具体字段（而不是只有 toast 一行）
- [x] 040 [P0] 日志 tail 改为增量 cursor（UI 不再每秒拉全量），减少带宽与渲染压力
- [x] 041 [P0] 日志上限/截断策略可配置（防止高输出进程导致内存膨胀）
- [x] 042 [P0] 增加 “Download logs/diagnostics” 按钮：导出最近 N 行 + run.json + instance.json
- [x] 043 [P0] 统一实例目录结构（如 `worlds/` `config/` `mods/`），跨游戏一致便于通用 UI
- [x] 044 [P0] 实例启动前检查磁盘剩余空间，低于阈值直接拒绝并给出阈值/现状
- [x] 045 [P0] RSPC/HTTP 层统一错误码（invalid_param/download_failed/spawn_failed/permission_denied…）
- [x] 046 [P0] control 支持“只读模式”（维护时禁止 start/stop/delete，仅查看）
- [x] 047 [P0] 关键操作加速率限制（频繁 start/stop 造成端口抖动、写盘压力）
- [x] 048 [P0] 一键“清理缓存”（Minecraft jars / Terraria zips）并显示占用空间与最近使用时间
- [x] 049 [P0] docker-compose 文档明确 `/data` 挂载与持久化策略，避免误以为数据在容器内
- [x] 050 [P0] 补齐文档：Terraria 版本号说明 + 常见依赖/报错对照表（以本项目运维为中心）

## P1（推荐 / 计划内）
- [ ] 051 [P1] Terraria 支持更多可选参数（seed/difficulty/journey 等）并映射到 serverconfig
- [ ] 052 [P1] Minecraft 支持更多 `server.properties` 参数（motd/max-players/online-mode 等）并做校验
- [ ] 053 [P1] Minecraft 支持 RCON（配置 + UI 发命令/看返回）
- [ ] 054 [P1] Terraria 支持 whitelist/banlist 管理（文件管理 + UI 操作入口）
- [ ] 055 [P1] UI 增加 Console 输入框（向 stdin 发送命令）并记录历史与常用命令
- [ ] 056 [P1] 支持实例“标签/分组”（prod/test/朋友局），支持过滤与批量操作
- [ ] 057 [P1] 支持实例排序（按状态/创建时间/CPU/内存/端口）
- [ ] 058 [P1] 支持实例搜索（按 id/名称/模板）
- [ ] 059 [P1] 实例详情页整合：参数、端口、日志、文件、备份、资源图一页完成
- [ ] 060 [P1] UI 展示下载进度条（bytes/total）并支持取消下载/重试
- [ ] 061 [P1] 下载层支持代理/镜像配置（环境变量/配置文件）
- [ ] 062 [P1] 为 Terraria zip 生成 sha256 并缓存（用于后续检测损坏/重复下载去重）
- [ ] 063 [P1] 加入“离线模式”：无网络时只允许启动已缓存版本，并在 UI 明确提示
- [ ] 064 [P1] 实例备份导出（tar.gz/zip）并允许下载到本地
- [ ] 065 [P1] 实例从备份恢复（上传 tar.gz/zip），并提供冲突处理（覆盖/新建）
- [ ] 066 [P1] 定时任务系统（cron）：备份、重启、更新检查、清理旧日志
- [ ] 067 [P1] 支持“启动前/启动后钩子”（受控命令集/白名单），用于写入配置或做检查
- [ ] 068 [P1] 模板“能力声明”（需要端口/需要 java/需要 libs/支持 console 等），UI 自动提示
- [ ] 069 [P1] Template 从 agent 拉 schema，web 动态渲染表单（减少前端硬编码）
- [ ] 070 [P1] 模板版本 pin：实例固定模板版本，升级时需要显式迁移并显示 diff
- [ ] 071 [P1] 实例克隆（复制参数+世界+配置）一键生成新实例
- [ ] 072 [P1] “导入现有世界”向导（选择路径或上传），自动放入正确目录
- [ ] 073 [P1] FS 页支持下载/上传/重命名/删除（配合权限开关与审计）
- [ ] 074 [P1] FS 页支持大文件流式下载与二进制文件预览（图片/zip 列表）
- [ ] 075 [P1] 日志页支持搜索/高亮（error/warn/stacktrace）与快速跳转
- [ ] 076 [P1] 日志页支持自动滚动开关、暂停、复制选中、清空视图
- [ ] 077 [P1] 日志支持 stdout/stderr 分流或标记来源（便于定位崩溃信息）
- [ ] 078 [P1] agent 增加事件流（started/stopped/downloaded/error）供 UI 实时订阅
- [ ] 079 [P1] 将轮询逐步替换为 WebSocket/SSE 推送（状态+日志）
- [ ] 080 [P1] 状态字段增强：启动耗时、上次退出原因、重启次数、上次启动参数摘要
- [ ] 081 [P1] 增加“最近心跳时间”与 agent 卡死检测（UI 明确告警）
- [ ] 082 [P1] 资源监控：每实例 CPU/RSS/IO、节点总资源，提供简单图表
- [ ] 083 [P1] 多节点：control 可连接多个 agent，实例可选择/自动分配到节点
- [ ] 084 [P1] 节点登记/心跳/自动下线（node unavailable 状态）
- [ ] 085 [P1] 节点调度策略：按负载/标签/亲和性/资源阈值选择节点
- [ ] 086 [P1] 节点级端口池与冲突管理（跨节点隔离，避免“全局端口”误判）
- [ ] 087 [P1] 实例迁移（stop->复制数据->在新节点启动）的最小可用流程
- [ ] 088 [P1] data 目录结构加入 `nodes/<node_id>/instances/...` 以隔离多节点数据
- [ ] 089 [P1] 引入数据库持久化实例/状态/审计（逐步替代 json 文件）
- [ ] 090 [P1] control 端复用 gRPC 连接（连接池/单例 client）减少频繁握手
- [ ] 091 [P1] agent/control 之间启用 TLS（mTLS 可选）与 token 认证
- [ ] 092 [P1] Web 登录支持多用户会话管理（refresh token、撤销、设备列表）
- [ ] 093 [P1] “只分享某个实例”的共享链接（只读状态/日志），带过期时间
- [ ] 094 [P1] API key 管理（创建/禁用/作用域：只读、实例管理、文件写等）
- [ ] 095 [P1] 前端主题与可访问性完善（键盘操作、对比度、ARIA）
- [ ] 096 [P1] 前端 i18n（中/英）与时间/单位本地化
- [ ] 097 [P1] 新手引导：一键创建 MC/Terraria 示例实例并给出下一步提示
- [ ] 098 [P1] 创建实例时展示 EULA/免责声明与官方来源说明（减少法律/信任风险）
- [ ] 099 [P1] “诊断”页面：版本信息、依赖检测、网络连通性、磁盘/权限检查
- [ ] 100 [P1] agent 自检：`java -version`、写 data root、bind 端口、下载连通性
- [ ] 101 [P1] Dockerfile 加入 healthcheck（grpc health 或 /healthz）并在 compose 展示
- [ ] 102 [P1] docker-compose 增加建议项（ulimit/open files/内存限制）与示例配置
- [ ] 103 [P1] 统一配置文件（yaml/toml）替代大量 env，并支持部分热加载
- [ ] 104 [P1] 提供 `alloyctl` CLI（登录、列模板、创建/启动/尾日志、下载诊断包）
- [ ] 105 [P1] 为下载/解压写单元测试（用本地小 zip/jar fixture）
- [ ] 106 [P1] 为 process manager 写集成测试（spawn/stop/kill、日志收集、退出码）
- [ ] 107 [P1] tracing 字段结构化（process_id/template_id/node_id/request_id）便于过滤
- [ ] 108 [P1] anyhow 文本错误升级为枚举错误（code + context），前端可做精准提示
- [ ] 109 [P1] web 展示版本号/commit hash（便于对齐部署版本与反馈）
- [ ] 110 [P1] release 流程：生成 changelog、tag、docker image 推送与回滚指引
- [ ] 111 [P1] 文档：本地开发一键脚本（db/control/agent/web）与常用调试命令
- [ ] 112 [P1] 文档：FAQ（端口占用、权限、数据目录、常见下载/启动报错）
- [ ] 113 [P1] 安全模式：禁用 FS 写入与删除实例，只允许启动/停止/查看
- [ ] 114 [P1] 维护窗口：到点自动 stop 全部实例并阻止新启动（可配置）
- [ ] 115 [P1] instance.json schema 校验与自动修复（缺字段填默认/迁移旧字段）
- [ ] 116 [P1] 参数 schema 支持 `secret` 标记：不写入日志、不在 UI 回显明文
- [ ] 117 [P1] secrets 从明文 params 分离（单独 secret store 文件/DB），并支持轮换
- [ ] 118 [P1] UI 直接编辑 `server.properties` / `serverconfig.txt`（带模板化提示与回滚）
- [ ] 119 [P1] Terraria 版本列表由后端提供 curated list 给 UI（带推荐/稳定标签）
- [ ] 120 [P1] 版本列表支持“推荐/稳定/旧版”标签与筛选（减少误选不兼容版本）

## P2（可选 / 需要评估）
- [ ] 121 [P2] Minecraft 支持 Paper/Purpur（下载、校验、缓存、参数模板）
- [ ] 122 [P2] Minecraft 支持 Fabric/Forge/NeoForge（安装器流程封装与版本兼容校验）
- [ ] 123 [P2] Terraria 支持 tModLoader（版本选择、mod 管理、依赖提示）
- [ ] 124 [P2] 增加 modpack/插件管理 UI（上传 zip、启用/禁用、版本展示）
- [ ] 125 [P2] Minecraft 插件自动下载/更新（受白名单/签名限制，降低供应链风险）
- [ ] 126 [P2] Terraria mods 自动下载/更新（受白名单/签名限制）
- [ ] 127 [P2] 世界/配置 Git 版本化（每次变更自动 commit，支持回滚）
- [ ] 128 [P2] 备份到 S3/MinIO（加密、生命周期、按实例隔离）
- [ ] 129 [P2] 备份校验（hash）与定期恢复演练（避免“备份不可用”）
- [ ] 130 [P2] 快照集成（LVM/btrfs/zfs）作为可选高性能备份方式
- [ ] 131 [P2] webhook 通知（启动、停止、崩溃、备份完成、更新可用）
- [ ] 132 [P2] Discord Bot（/start /stop /status /logsTail）用于群里运维
- [ ] 133 [P2] 邮件/Telegram/企业微信通知集成
- [ ] 134 [P2] UI 多窗口体验：日志弹窗可脱离/分屏/固定到侧边
- [ ] 135 [P2] 高级过滤器：只看 failed、只看某模板、按标签组合筛选
- [ ] 136 [P2] 实例配额（CPU/内存/磁盘）与超限拒绝/告警
- [ ] 137 [P2] Linux cgroups 限制每实例资源（避免某实例拖垮整机）
- [ ] 138 [P2] 自动关服：无人在线/空闲 N 分钟自动 stop（可白名单）
- [ ] 139 [P2] 自动开服：收到 ping/连接请求时自动 start（需要明确安全边界）
- [ ] 140 [P2] 在线玩家列表展示（Minecraft query/RCON；Terraria 解析日志/状态）
- [ ] 141 [P2] 聊天/公告发送（Minecraft RCON；Terraria console）
- [ ] 142 [P2] Minecraft 世界预生成（chunk pregeneration）任务与进度展示
- [ ] 143 [P2] 后台任务队列（下载/备份/预生成）与 UI 任务中心
- [ ] 144 [P2] 任务取消/重试/优先级（例如“先启动再下载其他”）
- [ ] 145 [P2] “模板市场”概念：从 git repo 拉取模板定义（需签名/审核）
- [ ] 146 [P2] 插件化 adapter 系统（每个游戏一个 crate/插件），便于扩展多游戏
- [ ] 147 [P2] 配置迁移器：模板升级时自动改 `serverconfig/properties`（并可预览 diff）
- [ ] 148 [P2] 实例导出为 docker compose / systemd unit（便于迁移到其他系统）
- [ ] 149 [P2] systemd 管理模式（可选替代内建 process manager，利用系统守护）
- [ ] 150 [P2] k8s 支持（Helm chart + PVC + Ingress），适合多节点/云环境
- [ ] 151 [P2] OAuth/OIDC 登录（GitHub/Google/自建）简化用户体系
- [ ] 152 [P2] 2FA（TOTP）与设备管理提升账号安全
- [ ] 153 [P2] IP allowlist/denylist（Web 与 agent 双层）
- [ ] 154 [P2] 反向代理/WAF 部署指南（Caddy/Nginx）与推荐安全配置
- [ ] 155 [P2] 自动生成 API 文档（OpenAPI 或 RSPC 文档页）
- [ ] 156 [P2] Prometheus `/metrics`（实例数、下载耗时、失败率、资源用量）
- [ ] 157 [P2] OpenTelemetry tracing（跨 web/control/agent 关联）
- [ ] 158 [P2] 压测脚本（大量实例、日志吞吐、并发下载）与性能基线
- [ ] 159 [P2] 解压安全加固（zip slip 防护、大小限制、拒绝可疑路径）
- [ ] 160 [P2] 外部下载 allowlist（只允许官方域名/镜像源），防止 SSRF/投毒
- [ ] 161 [P2] 支持离线包导入（管理员上传 zip/jar 到缓存）+ 校验与元数据记录
- [ ] 162 [P2] 只读共享缓存（多节点共享 NFS/对象存储）减少重复下载
- [ ] 163 [P2] Windows 节点支持（先从 Minecraft 开始，进程/路径/权限差异适配）
- [ ] 164 [P2] macOS 节点支持（开发/测试用）
- [ ] 165 [P2] 多架构支持（x86_64/arm64）并对二进制差异做分发策略
- [ ] 166 [P2] UI 内嵌“运行手册”（每模板说明、参数解释、常见问题）
- [ ] 167 [P2] instance 级“变更记录”（参数/文件变更 diff）并可回滚
- [ ] 168 [P2] 文件编辑器增强：语法高亮、只读提示、保存前 diff 预览
- [ ] 169 [P2] world 浏览器：列世界文件、大小、最后修改时间、一键下载/恢复
- [ ] 170 [P2] 自动清理策略（旧日志、旧下载、旧临时文件）并可预览将释放空间

## P3（以后再说 / 有空再做）
- [ ] 171 [P3] 桌面客户端（Tauri/Electron）：局域网发现、离线管理、更强交互
- [ ] 172 [P3] 移动端 App（只读状态/通知/一键启停）
- [ ] 173 [P3] 多租户（团队/组织/空间隔离）与配额/审计体系
- [ ] 174 [P3] 用量统计/计费（面向 SaaS 场景）
- [ ] 175 [P3] control 高可用（多副本、leader election、滚动升级）
- [ ] 176 [P3] 实例“热迁移/无感切换”（至少数据/端口接管，难度高）
- [ ] 177 [P3] 供应链安全扫描（插件/mod 签名验证、SBOM、漏洞告警）
- [ ] 178 [P3] 自动化更新引擎（定期检查新版本并提供灰度升级/回滚）
- [ ] 179 [P3] 蓝绿发布（新实例启动验证后再切换对外入口）
- [ ] 180 [P3] 统一日志与审计导出到外部系统（Loki/ELK/Splunk）
- [ ] 181 [P3] 可视化 world 管理（地图预览/玩家位置等，依赖游戏侧插件）
- [ ] 182 [P3] 支持更多游戏：Valheim、Factorio、DST 等（形成通用 adapter 框架）
- [ ] 183 [P3] 通用 SteamCMD 游戏模板（受控白名单）扩大覆盖面
- [x] 188 [P1] 新增 DSP Nebula 专服模板（参数校验、端口探测、文档）
- [ ] 184 [P3] 提供 SDK（Rust/TS）让第三方写模板/adapter，并可本地调试
- [ ] 185 [P3] 模板签名体系（签名、验证、锁定版本、可追溯发布者）
- [ ] 186 [P3] 内置 secrets 管理器（Vault/AWS KMS 等）统一密钥与轮换
- [ ] 187 [P3] 策略引擎（OPA）做细粒度授权（谁能看日志/改参数/写文件）
- [ ] 188 [P3] “可观察性面板”三合一（trace/metrics/logs）并支持关联跳转
- [ ] 189 [P3] 自动生成问题报告（采集诊断包+环境信息，打包上传/分享链接）
- [ ] 190 [P3] AI 助手：根据日志自动给出修复建议并支持“一键应用修复（可审计）”
- [ ] 191 [P3] AI 参数建议（按机器配置/玩家数推荐内存、视距、tick 等）
- [ ] 192 [P3] 存档差分备份（去重、增量、快速回滚）
- [ ] 193 [P3] 内容寻址缓存（下载/备份去重，跨节点共享）
- [ ] 194 [P3] 对象存储直挂世界文件（降低本地磁盘瓶颈，需一致性策略）
- [ ] 195 [P3] 浏览器远程终端（受控）用于维护节点（审计/限权）
- [ ] 196 [P3] UI 可插拔组件/主题系统（不同团队定制品牌与工作流）
- [ ] 197 [P3] 开放 Marketplace：模板/插件/主题共享（含审核流程与信任体系）
- [ ] 198 [P3] CI/CD 集成（从 Git push 自动部署 modpack/配置并触发重启）
- [ ] 199 [P3] 灾备/跨机房复制（远程备份+一键恢复）
- [ ] 200 [P3] 零信任部署模式（mTLS、短期证书、设备证明、端到端加密）
