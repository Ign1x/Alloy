syntax = "proto3";

package alloy.agent.v1;

// ProcessService is the agent-side process supervision API.
//
// IMPORTANT: control/web do not supply arbitrary cmd/cwd/env. They select a
// template_id and provide validated params. The agent maps templates to safe
// spawn specs.
service ProcessService {
  rpc ListTemplates(ListTemplatesRequest) returns (ListTemplatesResponse);
  rpc StartFromTemplate(StartFromTemplateRequest) returns (StartFromTemplateResponse);
  rpc WarmTemplateCache(WarmTemplateCacheRequest) returns (WarmTemplateCacheResponse);
  rpc GetCacheStats(GetCacheStatsRequest) returns (GetCacheStatsResponse);
  rpc ClearCache(ClearCacheRequest) returns (ClearCacheResponse);
  rpc Stop(StopProcessRequest) returns (StopProcessResponse);
  rpc ListProcesses(ListProcessesRequest) returns (ListProcessesResponse);
  rpc GetStatus(GetStatusRequest) returns (GetStatusResponse);
  rpc TailLogs(TailLogsRequest) returns (TailLogsResponse);
}

message ListTemplatesRequest {}

enum ParamType {
  PARAM_TYPE_UNSPECIFIED = 0;
  PARAM_TYPE_STRING = 1;
  PARAM_TYPE_INT = 2;
  PARAM_TYPE_BOOL = 3;
}

message TemplateParam {
  string key = 1;
  string label = 2;
  ParamType type = 3;
  bool required = 4;
  string default_value = 5;
  // Only used for int params.
  int64 min_int = 6;
  int64 max_int = 7;
  // Optional enum values (for string params).
  repeated string enum_values = 8;
  // Whether the param is considered sensitive (e.g. password).
  bool secret = 9;
  string placeholder = 10;
  string help = 11;
  // Advanced params are hidden unless the user opts in.
  bool advanced = 12;
}

message ProcessTemplate {
  string template_id = 1;
  string display_name = 2;
  repeated TemplateParam params = 3;
}

message ListTemplatesResponse {
  repeated ProcessTemplate templates = 1;
}

enum ProcessState {
  PROCESS_STATE_UNSPECIFIED = 0;
  PROCESS_STATE_STARTING = 1;
  PROCESS_STATE_RUNNING = 2;
  PROCESS_STATE_STOPPING = 3;
  PROCESS_STATE_EXITED = 4;
  PROCESS_STATE_FAILED = 5;
}

message ProcessStatus {
  string process_id = 1;
  string template_id = 2;
  ProcessState state = 3;
  uint32 pid = 4;
  bool has_pid = 5;
  int32 exit_code = 6;
  bool has_exit_code = 7;
  string message = 8;
  ProcessResources resources = 9;
}

message ProcessResources {
  // CPU usage over the last sampling interval, in basis points (1/100 of a percent).
  uint32 cpu_percent_x100 = 1;
  // Resident set size in bytes (best-effort).
  uint64 rss_bytes = 2;
  // Best-effort IO totals from /proc.
  uint64 read_bytes = 3;
  uint64 write_bytes = 4;
}

message StartFromTemplateRequest {
  string template_id = 1;
  map<string, string> params = 2;
}

message StartFromTemplateResponse {
  ProcessStatus status = 1;
}

message WarmTemplateCacheRequest {
  string template_id = 1;
  map<string, string> params = 2;
}

message WarmTemplateCacheResponse {
  bool ok = 1;
  string message = 2;
}

message CacheEntry {
  string key = 1;
  string path = 2;
  uint64 size_bytes = 3;
  uint64 last_used_unix_ms = 4;
}

message GetCacheStatsRequest {}

message GetCacheStatsResponse {
  repeated CacheEntry entries = 1;
}

message ClearCacheRequest {
  // If empty, clear all caches.
  repeated string keys = 1;
}

message ClearCacheResponse {
  bool ok = 1;
  uint64 freed_bytes = 2;
  repeated CacheEntry cleared = 3;
}

message StopProcessRequest {
  string process_id = 1;
  uint32 timeout_ms = 2;
}

message StopProcessResponse {
  ProcessStatus status = 1;
}

message ListProcessesRequest {}

message ListProcessesResponse {
  repeated ProcessStatus processes = 1;
}

message GetStatusRequest {
  string process_id = 1;
}

message GetStatusResponse {
  ProcessStatus status = 1;
}

message TailLogsRequest {
  string process_id = 1;
  uint32 limit = 2;
  string cursor = 3;
}

message TailLogsResponse {
  repeated string lines = 1;
  string next_cursor = 2;
}
